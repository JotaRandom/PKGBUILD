# $Id: PKGBUILD 74703 2012-08-02 08:45:29Z bpiotrowski $
# Contributor: Bart≈Çomiej Piotrowski <nospam@bpiotrowski.pl>
# Contributor: AndyRTR <andyrtr@archlinux.org>
# Contributor: kiefer <jorgelmadrid@gmail.com>
# Maintainer: Roland Singer <roland@manjaro.org>

pkgname=lxdm-manjaro
_pkgname=lxdm
pkgver=0.4.1
pkgrel=1
pkgdesc='Lightweight X11 Display Manager'
arch=('i686' 'x86_64')
url="http://sourceforge.net/projects/lxdm/"
license=('GPL')
groups=('lxde')
replaces=('lxdm')
provides=('lxdm')
conflicts=('lxdm')
depends=('gtk2' 'xorg-server' 'lxdm-arch-theme')
optdepends=('polkit-gnome: to run lxdm-config directly from menu')
makedepends=('intltool')
install=${_pkgname}.install
backup=('etc/lxdm/lxdm.conf' 'etc/pam.d/lxdm' 'etc/lxdm/Xsession'
        'etc/lxdm/PreLogin' 'etc/lxdm/LoginReady' 'etc/lxdm/PostLogin'
        'etc/lxdm/PostLogout' 'etc/lxdm/PreReboot' 'etc/lxdm/PreShutdown')

source=(http://downloads.sourceforge.net/lxde/$_pkgname-$pkgver.tar.gz
		lxdm.pam  lxdm.service
		lxdm-0.4.1-Xsession-source-profile.patch
		lxdm-0.4.1-conf.patch
		lxdm-0.4.1-event-check-bug.patch
		lxdm-0.4.1-industrial-greeter-ui.patch
		lxdm-0.4.1-modern-systems.patch
		lxdm-0.4.1-nolang-show-sessions.patch
		lxdm-0.4.1-pam-env-vars.patch
		lxdm-0.4.1-ecryptfs.patch
		org.manjaro.pkexec.lxdm-config.policy
                lxdm-config.desktop
                #####################################
                ## Custom Manjaro Login Pane Patch ##
                #####################################
                lxdm.login_pane.patch)

prepare() {

    cd $srcdir/$_pkgname-$pkgver
    patch -Np1 -i $srcdir/lxdm-0.4.1-event-check-bug.patch
    patch -Np1 -i $srcdir/lxdm-0.4.1-nolang-show-sessions.patch
    patch -Np1 -i $srcdir/lxdm-0.4.1-pam-env-vars.patch
    patch -Np1 -i $srcdir/lxdm-0.4.1-ecryptfs.patch

    #####################################
    ## Custom Manjaro Login Pane Patch ##
    #####################################
    patch -Np0 -i $srcdir/lxdm.login_pane.patch

}

build() {

    cd $srcdir/$_pkgname-$pkgver
    ./configure --sysconfdir=/etc --prefix=/usr --libexecdir=/usr/lib/lxdm \
    --bindir=/usr/bin \
    --sbindir=/usr/bin

    make
  	
    patch -Np0 -i $srcdir/lxdm-0.4.1-modern-systems.patch
    patch -Np0 -i $srcdir/lxdm-0.4.1-conf.patch
    patch -Np0 -i $srcdir/lxdm-0.4.1-Xsession-source-profile.patch
    patch -Np0 -i $srcdir/lxdm-0.4.1-industrial-greeter-ui.patch

}

package() {

    cd $srcdir/$_pkgname-$pkgver
    make DESTDIR=$pkgdir sbindir=/usr/bin install
    install -m644 $srcdir/lxdm.pam $pkgdir/etc/pam.d/lxdm
    install -Dm644 $srcdir/lxdm.service $pkgdir/usr/lib/systemd/system/lxdm.service
    install -d $pkgdir/var/{lib,run}/lxdm

    # fix the greeter location
    sed -i -e 's/local\/libexec/lib\/lxdm/' $pkgdir/etc/lxdm/lxdm.conf
    sed -i 's:sbin:bin:' $pkgdir/usr/bin/lxdm

    # avoid conflict with filesystem>=2012.06
    rm -r $pkgdir/var/run

    # Fix logout behavior
    echo '#!/usr/bin/env sh' > "${pkgdir}/etc/lxdm/PostLogout"
    echo '' >> "${pkgdir}/etc/lxdm/PostLogout"
    echo '# Kills all your processes when you log out.' >> "${pkgdir}/etc/lxdm/PostLogout"
    echo 'killall --user $USER -TERM' >> "${pkgdir}/etc/lxdm/PostLogout"
    echo '' >> "${pkgdir}/etc/lxdm/PostLogout"
    echo '# Sets the desktop background to solid black. Useful if you have multiple monitors.' >> "${pkgdir}/etc/lxdm/PostLogout"
    echo 'xsetroot -solid black' >> "${pkgdir}/etc/lxdm/PostLogout"

    # Install policy file
    install -Dm644 "${srcdir}/org.manjaro.pkexec.lxdm-config.policy" "${pkgdir}/usr/share/polkit-1/actions/org.manjaro.pkexec.lxdm-config.policy"

    # Install launcher script
    echo '#!/usr/bin/env sh' > ${pkgdir}/usr/bin/lxdm-config-pkexek
    echo 'user=$(whoami)' >> ${pkgdir}/usr/bin/lxdm-config-pkexec
    echo 'pkexec "/usr/bin/lxdm-config" --user "$user" "$@"' >> ${pkgdir}/usr/bin/lxdm-config-pkexec
    chmod 755 ${pkgdir}/usr/bin/lxdm-config-pkexec

    # Install desktop file
    install -Dm644 $srcdir/${_pkgname}-config.desktop $pkgdir/usr/share/applications/${_pkgname}-config.desktop

}

md5sums=('8da1cfc2be6dc9217c85a7cf51e1e821'
         '9cc734228696a3c6f06d91bba61b03c1'
         'b86317143ae44d7ed38c150fe4f25502'
         'd2e4a4a22ee2aa1a986be154c647b6c6'
         'f17f3b9a84ecc96885d69acbc2f479c6'
         'a1e3c46a8bef691bc544028f5b6cfe22'
         '2c4afdbe3532be4f90d8f6240d352766'
         'baed9055e8825a5511712bc095197519'
         '28475239d0c8b4fd778ec49f5ec72962'
         '4c1d43e81e9a256e8d1ea7686c24b3d3'
         '17065e451c62184e16d066589e119128'
         'a0da2a0df50666eac55d5bafa52ff7df'
         '0ffbec9545ec65a9f4a0de1cf0fb0a64'
         '15f39d8a8e4198d9a27676339231ee79')
