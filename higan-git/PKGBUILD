# Maintainer: Abelardo Ricart

pkgname=higan-git
pkgver=20130307
pkgrel=1
pkgdesc="A Nintendo multi-system emulator formerly known as bsnes"
arch=('i686' 'x86_64')
url=http://byuu.org/higan/
license=(GPL)
replaces=('bsnes')
conflicts=('higan')
depends=('openal' 'libgl')
optdepends=('alsa' 'pulseaudio' 'sdl')
source=('higan_gcc.patch' 'ananke_gcc.patch')
install=higan.install
md5sums=('049b514c1c3ca847b7efae50dcd0e3b6' '8431814f9ff3d8e5b2f438816efa1ef5')

_gitroot="git://gitorious.org/bsnes/bsnes.git"
_gitname="bsnes"

build() {
	cd "${srcdir}"
	msg2 "Connecting to GIT server..."
		if [[ -d "$_gitname" ]]; then
			cd "$_gitname" && git pull origin
			msg2 "The local files are updated."
		else
			git clone "$_gitroot" "$_gitname"
		fi
	msg2 "GIT checkout done or server timeout."

	rm -rf "$srcdir/$_gitname-build"
	git clone "$srcdir/$_gitname" "$srcdir/$_gitname-build"
	cd "$srcdir/$_gitname-build"
	
	msg2 "Patching..."
	cd "${srcdir}/$_gitname-build/higan/nall"
	patch -p0 -i ${srcdir}/higan_gcc.patch
	cd "${srcdir}/$_gitname-build/higan"
	make clean && make profile=performance
	cd "${srcdir}/$_gitname-build/ananke/nall"
	patch -p0 -i ${srcdir}/ananke_gcc.patch
	cd "${srcdir}/$_gitname-build/ananke"
	make clean && make
}

package()
{
  # Install higan
  cd "${srcdir}/$_gitname-build/higan"
  install -D -m 755 out/higan ${pkgdir}/usr/bin/higan
  install -D -m 644 data/higan.png ${pkgdir}/usr/share/pixmaps/higan.png
  install -D -m 644 data/higan.desktop ${pkgdir}/usr/share/applications/higan.desktop
  
  # Install ananke support library
  cd "${srcdir}/$_gitname-build/ananke"
  install -D -m 755 libananke.so ${pkgdir}/usr/lib/libananke.so.1
  ln -s /usr/lib/libananke.so.1 ${pkgdir}/usr/lib/libananke.so
  
  # Create config folders in user's $HOME directory
  if [ ! -d ~/.config/ananke ]; then mkdir ~/.config/ananke; fi
  if [ ! -d ~/.config/higan ]; then mkdir ~/.config/higan; fi
  
  # Copy over config files.
  cd "${srcdir}/$_gitname-build/higan"
  mkdir -p ${pkgdir}/usr/share/higan
  cp -R ../shaders ${pkgdir}/usr/share/higan/Video\ Shaders
  cp -R profile/* ${pkgdir}/usr/share/higan
  cp data/cheats.bml ${pkgdir}/usr/share/higan
}

